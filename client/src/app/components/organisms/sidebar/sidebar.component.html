<div style="display: flex; gap: 10px">
    <span class="secondary-100">{{ (loggedInUser$ | async)?.username }}</span>
    <button (click)="logout()">logout</button>
</div>

<div class="spacer"></div>

<h2>Chats</h2>
<p *ngIf="loadingChatPreviews$ | async">
    {{ (loadingChatPreviews$ | async) && 'loading' }}
    <loading-spinner></loading-spinner>
</p>
<ul class="chats">
    <li
        *ngFor="let chat of chatPreviews$ | async"
        class="chat"
        [class.active]="chat.friendshipOrChatGroupId == (activeChatId$ | async)"
        (click)="setChatActive(chat.friendshipOrChatGroupId)"
    >
        <!-- <div class="image"></div> -->
        <div class="wrapper">
            <div class="title cut-text">{{ chat.title }}</div>
            <div class="last-message cut-text">
                <span
                    class="username"
                    *ngIf="
                        chat.lastMessage &&
                        (chat.chatType == ChatType.GROUP || (loggedInUser$ | async)?.id == chat.lastMessage.user.id)
                    "
                    >{{
                        (loggedInUser$ | async)?.id == chat.lastMessage.user.id
                            ? 'You'
                            : chat.lastMessage.user.username
                    }}:
                </span>
                <span class="text">{{ chat.lastMessage?.text || '&nbsp;' }}</span>
            </div>
        </div>
        <span class="time">{{ chat.lastMessage?.timestamp | date: 'shortTime' }}</span>
    </li>
</ul>

<button (click)="createChat()">create Chat</button>
<button (click)="joinGlobalChat()">join global Chat</button>

<div class="spacer"></div>

<h2>Invitations</h2>
<div class="status-filter">
    <!-- prettier-ignore -->
    <button
            [class.isActiveFilter]="invitationsFilter == 'pending'"
            (click)="loadInvitations(InvitationStatus.PENDING)"
        >
            pending
        </button>
    <button
        [class.isActiveFilter]="invitationsFilter == 'accepted'"
        (click)="loadInvitations(InvitationStatus.ACCEPTED)"
    >
        accepted
    </button>
    <button
        [class.isActiveFilter]="invitationsFilter == 'declined'"
        (click)="loadInvitations(InvitationStatus.DECLINED)"
    >
        declined
    </button>
</div>
{{ (loadingInvitations$ | async) ? 'Loading...' : '' }}
<span>
    {{ (invitations$ | async)?.length }}
    {{ invitationsFilter }}
</span>
<ul class="invitations">
    <li *ngFor="let invitation of invitations$ | async">
        {{ invitation.inviter.username }}
        <span class="response-actions">
            <button
                (click)="respondToInvitation(invitation.id, 'accept')"
                [disabled]="invitation.status == InvitationStatus.ACCEPTED"
            >
                accept
            </button>
            <button
                (click)="respondToInvitation(invitation.id, 'decline')"
                [disabled]="invitation.status != InvitationStatus.PENDING"
            >
                decline
            </button>
        </span>
    </li>
</ul>

<div class="spacer"></div>

<h3>Invite a friend</h3>
<input
    type="text"
    placeholder="Search for users"
    #userSearchInput
    (keydown.enter)="searchUsers(userSearchInput.value)"
/>
<button (click)="searchUsers(userSearchInput.value)">search</button>

<!-- @TODO: add loading state -->
<ul>
    <li *ngFor="let user of userSearchResult">
        {{ user.username }}
        {{ user.bio }}
        <button *ngIf="!user.friendshipId" (click)="sendFriendInvitation(user.id)">Invite</button>
    </li>
    {{
        userSearchResult?.length == 0 ? "No user with '" + userSearchInput.value + "' found" : ''
    }}
</ul>
